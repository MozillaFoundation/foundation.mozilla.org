language: python
services: docker
dist: xenial
env:
  global:
  - DOCKER_USERNAME=mofodevops
  - DOCKER_REPO=mozillafoundation/foundation.mozilla.org
  - secure: 4OI4AidOcRE5vUGqmmSN2KhgH+7rZvSzrzMuKEfT5/eMSlBmWNSAU9hYQ/dJX9drlCJrjPRM5r5VVwSIQXo1qxlDmCqatRKbq/JdKcJPXA3ZS1WFxUHiDMVzP27EONlNqNXTqE0Mfy59cQRgWTnNYkkI1vX2ZwNLmRSPPKXSEt29rsPcF63rr1xF//UZ1riEvbve2sFZqvAQckLAyCnuXv6cX157YTt5vatRxmOZxbjYWdRJlOKqWTxjlpSJ6qOVRHSjvsGbJoo/oeALV4WMKWJ9EFQfNWSpjcmqqNnUQp8kf65XC9i8HXo7c7Szf8TeCnaAksKINoHTWOccq2pTkcnkMWBppNVGtBjvjzrFBodIJFhC5mCe+yBkgdZK1I17Se2N6hIqjikcMUNI93SBE4KSsrg8TYh5glWkMw5p+ehJuqCUq5xl2t3KielOvXT0c51PjAStWht74q0OMJJ3V4IznogBDt82zgUunTGDtgQL4SvLd68roaF9Hii2oVRwg9WFftKIgyH/Uo9OJ+gHKIQU/Gdro5BoIjHdqSfLgSIpl/IHnRHd3mbcjHjjNzTrpKYmf/Eeb4PNZEX6SNy8WFJ2eTHwMpHbAvrC+XKt/yz6+c5VMpFFRYt9nRSJiy8JmWVBEy+RtpxcMotNxFd5bjZ3VsL77kFmHjZkyLo4h5o=
  - secure: HIzjSNuo4Gs9YYk4GqlJt1atL4l8yVLaRX2KetMh7hvqpzBGNEhA3mAkvgLkAjLckX8v9+IWUWy2cZU7XP7CBG8oPaxYw6+tKojYHr+snFRFrGvYoZ5s8e6k+5J6FLGdHH8LSvCJyMzNgDGKEJUR1hJl0YYI+/g6AOTfakXpW9mEfVgFVXeZh25RIbwQV3LD6+wbxGGjGhLAHXIwUr5QEiYDhYjngtacROTuXNs5/bY7As1qtiDxNdz7dnY54biHnptwRHO7zcXvgs1N9nvHnZtE+sbbDOXO0Qyxjkj2BB5IoMgoA1XiaeM7BUuAdZyuRwbhGcZapLDcjG630es2cNu0HuKYcNgC0bFyCSWN4uxf02ip6bcvvcu6jFMWHD6FjifC7Pob7x+TLECfPQO7MX/ZlTl2Md3LBfJCkFZd1zTG3Vgg0gY7O5DR7fw5XY8I3nWRVSlgJEMP0brBnTVOO0mnvIzcrUs93L1uAnd1YuERKF6hYIXPwtYMc1tIYtmj0Xm7kxfrncQu3gsIIuvF30U5x1v+NYfFKPqMu64MM9wZlFZq/Q+sSYAi24upA4llwaLjAcM/pueOPHeXTBAzkkHqlBTchm819SC+WFfZH/QjYcpg33kjm3yLxbDmB0y0vk0waLFyBxGNffjFyVhyBbrphahqaPnAzKWpus4aa1Y=
  - secure: 0ldmvzmC73hRSAAEODJevQTKdG4hIuCdswQxJn4RHi9lVDdrmZIOalVBi0WgCcvbcunz28a9unpZQflLP2LRcQ65It8tb+C7GHYptEp2vOrK5E1cvSIFWIgPWipsqsl3xK8HIeTSADFektbN+MCeNgq6rbuOyr536UgfYFm6X1pgVLp3zLsbyfOwalLKPBIfS4Nti2rP8PxTJk1Vu3nqOLXEd1JN5nix3atN4DgOibHZZpyEdh/leEeKdeZSV5DC7jS/sxDBVr1UQPQ+grsMlZqzTnF5jVk28mXnlw0IhHH+nMyAHZc79w1zuaBqjOXBHdCTvhQjKWdAsrQvtwCpwpVHI655V1+H/UA0o8ZSjSfE2WfA3/l+ti8SB8TqMw2yIzpMG5Pa5eGV72szy2RCjA5g0PKhI5vCfsona8f1BgT4F5zE/gFR+tWh+6vILJ2wLtwxkHb+2l/3GRunsBzQkOqu+YAWSQ7c5d3ueTLnRrKI+s4ovzAaMLE4DOSRxHGC8I0v2e76pLrDSK9WpKwZJBS/pj4o+wTmRYvau5G5pmJZt5nN4l0n1T2JslwQYHdMZN3pn8bjT8sQMHJVxFhD5RrwwYA+1NgH48bgyqh6f756+7UVrVUHhF9cr96Nkhw/ymq+ppNhx2KPXPsiRyK4xGAR6cxYhLOj90re2KVeBcA=

before_script:
- if [ $TRAVIS_EVENT_TYPE == "pull_request" ]; then eval NODE_TAG=$TRAVIS_PULL_REQUEST_BRANCH-node;
  eval PYTHON_TAG=$TRAVIS_PULL_REQUEST_BRANCH-python; eval APP_BUILD_TAG=$TRAVIS_PULL_REQUEST_BRANCH-app-build;
  eval CYPRESS_TAG=$TRAVIS_PULL_REQUEST_BRANCH-cypress; else eval NODE_TAG=$TRAVIS_BRANCH-node;
  eval PYTHON_TAG=$TRAVIS_BRANCH-python; eval APP_BUILD_TAG=$TRAVIS_BRANCH-app-build;
  eval CYPRESS_TAG=$TRAVIS_BRANCH-cypress; fi
- echo $NODE_TAG
- echo $PYTHON_TAG
- echo $APP_BUILD_TAG
- echo $CYPRESS_TAG
- export PYTHON_TAG=$PYTHON_TAG
- export APP_BUILD_TAG=$APP_BUILD_TAG
- export CYPRESS_TAG=$CYPRESS_TAG
- export COVERALLS_REPO_TOKEN=$COVERALLS_REPO_TOKEN

jobs:
  include:
  - stage: Build
    name: Node image
    install: skip
    script:
    - docker pull $DOCKER_REPO:$NODE_TAG || true
    - docker build --pull --cache-from $DOCKER_REPO:$NODE_TAG --tag $DOCKER_REPO:$NODE_TAG
      --file "./travis-scripts/Dockerfile.node" .
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push $DOCKER_REPO:$NODE_TAG

  - stage: Build
    name: Django app image
    install: skip
    script:
    - docker pull $DOCKER_REPO:$APP_BUILD_TAG || true
    - docker build --pull --cache-from $DOCKER_REPO:$APP_BUILD_TAG --tag $DOCKER_REPO:$APP_BUILD_TAG
      --target node-build --file "./travis-scripts/Dockerfile.python" .
    - docker pull $DOCKER_REPO:$PYTHON_TAG || true
    - docker build --pull --cache-from $DOCKER_REPO:$APP_BUILD_TAG --cache-from $DOCKER_REPO:$PYTHON_TAG
      --tag $DOCKER_REPO:$PYTHON_TAG --target application --file "./travis-scripts/Dockerfile.python"
      .
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker push $DOCKER_REPO:$APP_BUILD_TAG
    - docker push $DOCKER_REPO:$PYTHON_TAG

  - stage: Test
    name: Node tests
    script:
    - docker run -it $DOCKER_REPO:$NODE_TAG npm run test

  - stage: Test
    name: Python tests
    script:
    - docker-compose -f travis-scripts/docker-compose.travis.yml run --rm backend
      flake8 tasks.py network-api
    - docker-compose -f travis-scripts/docker-compose.travis.yml run --rm backend
      sh -c "coverage run --source './network-api/networkapi' network-api/manage.py
      test networkapi && coveralls"

  - stage: Test
    name: Visual regression tests
    script:
    - docker-compose -f travis-scripts/docker-compose.travis.yml pull cypress || true
    - docker-compose -f travis-scripts/docker-compose.travis.yml build cypress
    - docker-compose -f travis-scripts/docker-compose.travis.yml run --rm backend_cypress
      python network-api/manage.py collectstatic --no-input --verbosity 0
    - docker-compose -f travis-scripts/docker-compose.travis.yml run --rm backend_cypress
      python network-api/manage.py migrate --no-input
    - docker-compose -f travis-scripts/docker-compose.travis.yml run --rm backend_cypress
      python network-api/manage.py block_inventory
    - docker-compose -f travis-scripts/docker-compose.travis.yml run --rm backend_cypress
      python network-api/manage.py sync_page_translation_fields
    - docker-compose -f travis-scripts/docker-compose.travis.yml run --rm backend_cypress
      python network-api/manage.py update_translation_fields
    - docker-compose -f travis-scripts/docker-compose.travis.yml run --rm backend_cypress
      python network-api/manage.py load_fake_data
    - docker-compose -f travis-scripts/docker-compose.travis.yml up cypress
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - docker-compose -f travis-scripts/docker-compose.travis.yml push cypress

  - stage: Deploy
    name: Deploy Maintenance page to S3
    script: skip
    deploy:
      provider: s3
      access_key_id: AKIAIDLSQZEZHN7MPGKA
      secret_access_key:
        secure: 41kXOgS58Ew64cXRE8KfDWMIAaSHdab/x2e0Pkv0pzEcEAbZloY2I6qlGs+K1JuK68WCicivU1cgmxgqSlA+Ol9cl3LD+XyeQsZqeIiYw9exZVHy1b49I2GPrW32mooasndJd29GNEqLfC5C1PuiVv4Ixs6USeshDH7+/SUFswO4A08F2S0C9r0bAhc9ff2TpsCSGBMNB9QgXvKnKvWB1S+mGbf9anrfJlPV0G6/PrMhldrVUrIULZidbiJuaW2FoKlt0YkEBYdzM+gdNI88VHRSrBnbbZrMs26sd4XBUtSeZcFA2QWnkfltRWLjpmPQWd6lcA53T7jNRr9z89HjEkxtz9N3Rb7qT1fuDwc6f9+5lj9G+kzxSeOoVBDNRNmhHTlEUIbODP80jcbr2GCCs6NgKq4yKApiA1lHA3REooBbGzkc53WtXfITDfK7h6BDDsJyGxBbU2gS66vvmGkv//wdXMsEwTfnmx0oHeQS1ad5emvOJSLIJXtCAqepStEBIhWRnN0ZCDhNTMoz63qE3Ne0KQhHX9j7UBLw7MRy6qGm2+Kd8ok2akqw8WUpQtUkgoxJzMHdx8BEYrFjfWEXnhqGriwWYRCNVI2MK53sE7ia8lzOil4jDAFURtRq7sJBBbgufc010gSHdBdcqm3haYr0XUgebR7hs2BD45+kVZA=
      bucket: foundation-mozilla-org-maintenance
      region: us-east-1
      acl: public_read
      local_dir: maintenance
      on:
        branch: master
        condition: "$TRAVIS_EVENT_TYPE != pull_request"
