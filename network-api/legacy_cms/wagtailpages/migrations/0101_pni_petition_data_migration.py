# Generated by Django 3.2.20 on 2023-09-04 18:21

from django.db import migrations
from django.db.models import Case, F, Value, When


def forwards(apps, schema_editor):
    Petition = apps.get_model("wagtailpages", "Petition")

    # Map value from the old comment_requirements field to the new show_comment_field
    # the current "none" value is mapped to False
    # the current "optional" value and "required" value are mapped to True
    Petition.objects.update(
        show_comment_field=Case(
            When(comment_requirements="none", then=Value(False)),
            default=Value(True),
        ),
        show_country_field=F("requires_country_code"),
        show_postal_code_field=F("requires_postal_code"),
    )


def backwards(apps, schema_editor):
    Petition = apps.get_model("wagtailpages", "Petition")

    # Map values backwards. Not a perfect mapping, since both "optional" and "required"
    # are mapped to "True" when migrating forwards, but "True" will be only mapped to
    # "optional" when migrating backwards.
    # A backwards data migration is included to facilitate moving fowards and backwards
    # in the migration tree.
    Petition.objects.update(
        comment_requirements=Case(
            When(show_comment_field=False, then=Value("none")),
            default=Value("optional"),
        ),
        requires_country_code=F("show_country_field"),
        requires_postal_code=F("show_postal_code_field"),
    )


class Migration(migrations.Migration):
    dependencies = [
        ("wagtailpages", "0100_pni_petition_add_show_fields"),
    ]

    operations = [
        migrations.RunPython(forwards, backwards),
    ]
