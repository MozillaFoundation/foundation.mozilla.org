# # Generated by Django 3.0.14 on 2021-08-10 18:19

from django.db import migrations
import wagtail.core.blocks
import wagtail.core.blocks.static_block
import wagtail.core.fields
import wagtail.images.blocks
import wagtailmedia.blocks


from networkapi.mozfest.models import MozfestPrimaryPage


def loop_through_pages_with_image_blocks(apps, schema):

    for page in MozfestPrimaryPage.objects.all():
        if hasattr(page, 'alias_of') and page.alias_of != None:
            # This is a page alias, rather than a real page
            continue
        # If this page doesn't have a Image that needs update, don't save it.
        # This will speed up how fast this task can run
        needs_saving = False
        # Only loop through streamfield data if there's a `body` field on the page
        if page.body:
            # Checking if page.body has raw_data, and looping through it.
            if hasattr(page.body, 'raw_data'):
                for block in page.body.raw_data:
                    # If the block type is an image,
                    # check if the image has the wide setting on.
                    if 'type' in block and block['type'] == "image":
                        # If so, set the new image_width value to wide.
                        if 'wide_image' in block['value'] and block['value']['wide_image'] == True:
                            block['value']['image_width'] = "wide"
                            needs_saving = True

            # If page is published already, continue to publish it.
            # Otherwise just save a revision for draft history.
            if needs_saving:
                revision = page.save_revision()
                if page.live:
                    revision.publish()

class Migration(migrations.Migration):

    dependencies = [
        ('mozfest', '0017_auto_20210818_0231'),
    ]

    operations = [
        migrations.RunPython(loop_through_pages_with_image_blocks)
    ]
