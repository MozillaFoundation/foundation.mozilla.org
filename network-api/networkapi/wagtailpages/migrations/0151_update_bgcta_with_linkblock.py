# Generated by Django 4.2.14 on 2024-07-18 22:50

import wagtail.blocks
import wagtail.documents.blocks
import wagtail.fields
from django.db import migrations

import networkapi.wagtailpages.validators


def migrate_link_field(apps, schema_editor):
    BuyersGuideCallToAction = apps.get_model("wagtailpages", "BuyersGuideCallToAction")
    for instance in BuyersGuideCallToAction.objects.all():
        if instance.link_label and (instance.link_target_url or instance.link_target_page):
            if instance.link_target_url:
                link_value = {
                    "link_to": "external_url",
                    "external_url": instance.link_target_url,
                    "label": instance.link_label,
                    "new_window": False,
                }
            elif instance.link_target_page:
                link_value = {
                    "link_to": "page",
                    "label": instance.link_label,
                    "new_window": False,
                    "page": instance.link_target_page,
                }

            stream_data = [("link", link_value)]
            instance.link = stream_data
            instance.save()


class Migration(migrations.Migration):

    dependencies = [
        ("wagtailpages", "0150_update_textonlyteaserblock_with_linkblock"),
    ]

    operations = [
        migrations.AddField(
            model_name="buyersguidecalltoaction",
            name="link",
            field=wagtail.fields.StreamField(
                [
                    (
                        "link",
                        wagtail.blocks.StructBlock(
                            [
                                ("label", wagtail.blocks.CharBlock()),
                                (
                                    "link_to",
                                    wagtail.blocks.ChoiceBlock(
                                        choices=[
                                            ("page", "Page"),
                                            ("external_url", "External URL"),
                                            ("relative_url", "Relative URL"),
                                            ("email", "Email"),
                                            ("anchor", "Anchor"),
                                            ("file", "File"),
                                            ("phone", "Phone"),
                                        ],
                                        label="Link to",
                                    ),
                                ),
                                ("page", wagtail.blocks.PageChooserBlock(label="Page", required=False)),
                                (
                                    "external_url",
                                    wagtail.blocks.URLBlock(
                                        help_text="Enter a full URL including http:// or https://",
                                        label="External URL",
                                        max_length=300,
                                        required=False,
                                    ),
                                ),
                                (
                                    "relative_url",
                                    wagtail.blocks.CharBlock(
                                        help_text='A path relative to this domain. For example, "/foo/bar"',
                                        label="Relative URL",
                                        max_length=300,
                                        required=False,
                                        validators=[networkapi.wagtailpages.validators.RelativeURLValidator()],
                                    ),
                                ),
                                (
                                    "anchor",
                                    wagtail.blocks.CharBlock(
                                        help_text='An id attribute of an element on the current page. For example, "#section-1"',
                                        label="#",
                                        max_length=300,
                                        required=False,
                                        validators=[networkapi.wagtailpages.validators.AnchorLinkValidator()],
                                    ),
                                ),
                                ("email", wagtail.blocks.EmailBlock(required=False)),
                                ("file", wagtail.documents.blocks.DocumentChooserBlock(label="File", required=False)),
                                ("phone", wagtail.blocks.CharBlock(label="Phone", max_length=30, required=False)),
                                (
                                    "new_window",
                                    wagtail.blocks.BooleanBlock(label="Open in new window", required=False),
                                ),
                            ]
                        ),
                    )
                ],
                blank=True,
                use_json_field=True,
            ),
        ),
        migrations.RunPython(migrate_link_field),
        migrations.RemoveField(
            model_name="buyersguidecalltoaction",
            name="link_label",
        ),
        migrations.RemoveField(
            model_name="buyersguidecalltoaction",
            name="link_target_page",
        ),
        migrations.RemoveField(
            model_name="buyersguidecalltoaction",
            name="link_target_url",
        ),
    ]
