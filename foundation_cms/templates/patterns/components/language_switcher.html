{% load i18n localization wagtailcore_tags %}

{% get_current_language as current_language %}
{% get_local_language_names as languages %}

<form id="language-switcher-form" action="{% url 'set_language' %}" method="post">
  <input type="hidden" name="next" id="language-next" value="" />

  <label for="language-switcher">{% trans "Language" %}</label>
  <select name="language" id="language-switcher">
    {% for language_code, language_name in languages %}
      {% language language_code %}
        {% if page and page.localized %}
          {% pageurl page.localized as localized_url %}
        {% else %}
          {% url 'home' as localized_url %}
        {% endif %}
        <option value="{{ language_code }}"
                data-url="{{ localized_url }}"
                {% if language_code == current_language %}selected{% endif %}>
          {{ language_name | capfirst }}
        </option>
      {% endlanguage %}
    {% endfor %}
  </select>
</form>

<script nonce="{{ request.csp_nonce }}">
  const form = document.getElementById('language-switcher-form');
  const selector = document.getElementById('language-switcher');
  const nextInput = document.getElementById('language-next');

  selector.addEventListener('change', () => {
    const opt = selector.options[selector.selectedIndex];
    nextInput.value = opt.dataset.url || "/";
    form.submit();
  });
</script>