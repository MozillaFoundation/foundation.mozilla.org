{% extends "base/base.html" %}
{% load wagtailcore_tags static i18n %}

{% block content %}
    <div class="campaign-page" data-page-id="{{ page.id }}" data-state="{{ state|default:'start' }}">

        <div class="campaign-content">
            {% if page.header %}
                {{ page.header }}
            {% else %}
                {{ page.title }}
            {% endif %}

            {% for block in page.body %}
                {% include_block block %}
            {% endfor %}
        </div>

        <!-- PETITION FORM STATE -->
        {% if page.cta and state == "start" %}
            <div class="petition-cta-container">
                {% if page.cta.share_bluesky %}
                    <div id="share-progress-bs" class='{{ page.cta.share_bluesky }} sp_bs_small d-none'></div>
                {% endif %}

                {% if page.cta.share_facebook %}
                    <div id="share-progress-fb" class='{{ page.cta.share_facebook }} sp_fb_small d-none'></div>
                {% endif %}

                {% if page.cta.share_email %}
                    <div id="share-progress-em" class='{{ page.cta.share_email }} sp_em_small bs-hidden'></div>
                {% endif %}

                {% if page.cta.header %}
                    {{ page.cta.header }}
                {% endif %}

                {% if page.cta.description %}
                    <div class="petition-description">
                        {{ page.cta.description|richtext }}
                    </div>
                {% endif %}

                <div class="petition-form-wrapper">
                    <p class="form-notice">
                        <small>{% trans "* Indicates a required field" %}</small>
                    </p>
                    <!-- Petition Form -->
                    {% include "campaigns/components/petition_form.html" with cta=page.cta %}
                </div>
            </div>
        {% endif %}

        <!-- SIGNED STATE - After petition is signed -->
        {% if state == "signed" %}
            <div class="petition-signed">
                {{ page.signed_header }}
                {% if page.signed_donation_question %}
                    {{ page.signed_donation_question }}
                {% endif %}
                {{ page.signed_body|richtext }}

                <div class="petition-actions">
                    {% if page.cta.donate_url %}
                        {% include "patterns/components/button.html" with classnames="with-heart-icon donation-button" url=page.cta.donate_url label=page.cta.donate_text button_style="btn-primary" %}
                    {% endif %}

                    <form method="POST" class="petition-actions-form" style="display: inline-block;">
                        {% csrf_token %}
                        <button
                            type="submit"
                            name="action"
                            value="share"
                            class="btn btn-secondary share-button"
                            data-label="No, I will share instead">
                            {% trans "No, I will share instead" %}
                        </button>
                    </form>

                    <form method="POST" class="petition-actions-form" style="display: inline-block;">
                        {% csrf_token %}
                        <button
                            type="submit"
                            name="action"
                            value="skip"
                            class="btn btn-link skip-button"
                            data-label="Sorry, not right now">
                            {% trans "Sorry, not right now" %}
                        </button>
                    </form>
                </div>
            </div>

        <!-- SHARING STATE -->
        {% elif state == "sharing" %}
            <div class="petition-share">
                {{ page.share_header }}
                {{ page.share_body|richtext }}

                <!-- Social sharing buttons -->
                {% if page.cta.share_bluesky %}
                    <div id="share-progress-bs" class='{{ page.cta.share_bluesky }} sp_bs_small'></div>
                {% endif %}

                {% if page.cta.share_facebook %}
                    <div id="share-progress-fb" class='{{ page.cta.share_facebook }} sp_fb_small'></div>
                {% endif %}

                {% if page.cta.share_email %}
                    <div id="share-progress-em" class='{{ page.cta.share_email }} sp_em_small'></div>
                {% endif %}

                <form method="POST" class="petition-actions-form">
                    {% csrf_token %}
                    <button
                        type="submit"
                        name="action"
                        value="skip"
                        class="btn btn-primary skip-button"
                        data-label="Sorry, not right now">
                    </button>
                </form>
            </div>

        <!-- THANK YOU STATE -->
        {% elif state == "end" %}
            <div class="petition-thank-you">
                {{ page.thank_you_header }}
                {{ page.thank_you_body|richtext }}
                <img src="{{ page.thank_you_image.url }}" alt="{{ page.thank_you_header|escape }}" max-width="100%" max-height="auto">
            </div>

        {% endif %}

    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://c.shpg.org/352/sp.js"></script>

    <script nonce="{{ request.csp_nonce }}">
        document.addEventListener('DOMContentLoaded', function() {
            {% if state == "sharing" %}
                if (window.ShareProgress) {
                    window.ShareProgress.init();
                }
            {% endif %}

            document.querySelectorAll('button[data-label]').forEach(button => {
                button.addEventListener('click', function() {
                    const label = this.getAttribute('data-label');
                    const action = this.getAttribute('name') === 'action' ? this.value : 'click';

                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'petition_flow_button', {
                            'action': action,
                            'label': label,
                            'page_id': '{{ page.id }}',
                            'state': '{{ state }}'
                        });
                    }

                    console.log(`Button clicked: ${label} (${action})`);
                });
            });
        });
    </script>
{% endblock %}
