from django.core.exceptions import ValidationError
from django.core.validators import RegexValidator
from django.db import models
from wagtail.admin.panels import FieldPanel, HelpPanel, MultiFieldPanel
from wagtail.images import get_image_model_string
from wagtail.models import PreviewableMixin, TranslatableMixin
from wagtail.search import index
from wagtail.snippets.models import register_snippet
from wagtail_localize.fields import SynchronizedField, TranslatableField

from foundation_cms.constants import url_or_query_regex


@register_snippet
class DonateBanner(TranslatableMixin, PreviewableMixin, models.Model):
    name = models.CharField(
        max_length=100,
        help_text="Identify this component for editors. This will not be displayed on the banner.",
    )
    title = models.CharField(
        max_length=60,
        help_text="Banner title - Recommended max character count of 30",
        default="Help Mozilla fight for a better internet this holiday season",
    )
    subtitle = models.CharField(
        max_length=200,
        help_text="Banner subtitle - Recommended max character count of 60",
        default=(
            "We're proudly nonprofit, working to keep the web healthy. "
            "Your contributions help build a safe and open internet."
        ),
    )
    cta_button_text = models.CharField(
        max_length=500,
        help_text="CTA button text",
        default="Support Mozilla",
    )
    cta_link = models.CharField(
        max_length=255,
        default="?form=donate",
        validators=[
            RegexValidator(
                regex=url_or_query_regex,
                message=(
                    "Please enter a valid URL (starting with http:// or https://), "
                    "or a valid query string starting with ? (Ex: ?form=donate)."
                ),
            ),
        ],
        help_text=(
            "If you would like the CTA button to link to a custom URL, "
            "please enter a valid URL (starting with http:// or https://), "
            "or a valid query string starting with ? (Ex: ?form=donate)."
        ),
    )
    foreground_image = models.ForeignKey(
        get_image_model_string(),
        models.PROTECT,
        related_name="+",
    )

    BANNER_STYLES = [
        ("legacy", "Legacy"),
        ("pushdown", "Pushdown"),
    ]

    banner_style = models.CharField(
        max_length=20,
        choices=BANNER_STYLES,
        default="legacy",
        help_text="Style of the banner to display",
    )

    fru_thermometer_embed_code = models.CharField(
        blank=True,
        help_text="Copy the HTML code generated by the desired FRU Thermometer element and paste it here.",
    )

    fru_stat_counter_embed_code = models.CharField(
        blank=True,
        help_text="Copy the HTML code generated by the desired FRU Stat Counter element and paste it here.",
    )

    fru_stat_counter_caption = models.CharField(
        blank=True,
        help_text="Text used to describe the FRU Stat Counter Number (e.g. 'donors so far').",
    )

    panels = [
        HelpPanel(content="To enable banner on site, visit the DonateBannerPage that is a child of the Homepage."),
        FieldPanel("name"),
        FieldPanel("banner_style"),
        FieldPanel("title"),
        FieldPanel("subtitle"),
        FieldPanel("cta_button_text"),
        FieldPanel("cta_link"),
        FieldPanel("foreground_image"),
        MultiFieldPanel(
            [
                FieldPanel("fru_thermometer_embed_code"),
                FieldPanel("fru_stat_counter_embed_code"),
                FieldPanel("fru_stat_counter_caption"),
            ],
            heading="FundraiseUp Elements",
        ),
    ]

    translatable_fields = [
        SynchronizedField("banner_style"),
        TranslatableField("title"),
        TranslatableField("subtitle"),
        TranslatableField("cta_button_text"),
        SynchronizedField("cta_link"),
        SynchronizedField("foreground_image"),
        SynchronizedField("fru_thermometer_embed_code"),
        SynchronizedField("fru_stat_counter_embed_code"),
        TranslatableField("fru_stat_counter_caption"),
    ]

    search_fields = [
        index.SearchField("name"),
        index.SearchField("title"),
        index.FilterField("locale_id"),
    ]

    class Meta(TranslatableMixin.Meta):
        verbose_name = "Donate Banner (New)"
        verbose_name_plural = "Donate Banners (New)"

    def __str__(self):
        return self.name

    def get_preview_template(self, request, mode_name):
        return "patterns/components/previews/donate_banner.html"

    def is_active(self):
        if self.site_donate_banner.exists():
            return True
        return False
