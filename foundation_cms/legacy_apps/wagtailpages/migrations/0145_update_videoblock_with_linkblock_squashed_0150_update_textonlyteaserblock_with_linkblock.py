# Generated by Django 4.2.25 on 2025-11-14 20:59

import re

import wagtail.blocks.migrations.migrate_operation
import wagtail.fields
from django.db import migrations

import foundation_cms.legacy_apps.utility.migration.operations

# Functions from the following migrations need manual copying.
# Move them and any dependencies into this file, then update the
# RunPython operations to refer to the local versions:
# foundation_cms.legacy_apps.wagtailpages.migrations.0145_update_videoblock_with_linkblock
# foundation_cms.legacy_apps.wagtailpages.migrations.0146_update_imageteaserblock_with_linkblock
# foundation_cms.legacy_apps.wagtailpages.migrations.0147_update_grouplistingblock_with_linkblock
# foundation_cms.legacy_apps.wagtailpages.migrations.0148_update_imagegridblock_with_linkblock
# foundation_cms.legacy_apps.wagtailpages.migrations.0149_update_listingblock_with_linkblock
# foundation_cms.legacy_apps.wagtailpages.migrations.0150_update_textonlyteaserblock_with_linkblock


# Via foundation_cms.legacy_apps.wagtailpages.migrations.0145_update_videoblock_with_linkblock
def migrate_0145_video_block(source_block):
    new_value = {
        "url": source_block["value"].get("url"),
        "caption": source_block["value"].get("caption"),
        "caption_url": [],
        "video_width": source_block["value"].get("video_width"),
    }
    if "captionURL" in source_block["value"] and source_block["value"]["captionURL"]:
        new_value["caption_url"] = [
            {
                "link_to": "external_url",
                "external_url": source_block["value"].get("captionURL"),
                "new_window": True,
            }
        ]
    return {
        **source_block,
        "value": new_value,
    }


# Via foundation_cms.legacy_apps.wagtailpages.migrations.0146_update_imageteaserblock_with_linkblock
def migrate_0146_image_teaser_block(source_block):
    new_value = {
        "title": source_block["value"].get("title", ""),
        "text": source_block["value"].get("text", ""),
        "image": source_block["value"].get("image"),
        "altText": source_block["value"].get("altText", ""),
        "link": [],
        "styling": source_block["value"].get("styling", "btn-primary"),
        "top_divider": source_block["value"].get("top_divider", False),
        "bottom_divider": source_block["value"].get("bottom_divider", False),
    }
    if "url" in source_block["value"] and source_block["value"]["url"]:
        new_value["link_button"] = [
            {
                "link_to": "external_url",
                "external_url": source_block["value"]["url"],
                "label": source_block["value"].get("url_label", ""),
                "new_window": True,
                "styling": source_block["value"].get("styling", "btn-primary"),
            }
        ]
    return {
        **source_block,
        "value": new_value,
    }


# Via foundation_cms.legacy_apps.wagtailpages.migrations.0147_update_grouplistingblock_with_linkblock
def migrate_0147_group_listing_block_cards(source_block):

    if "cards" in source_block["value"]:
        for card in source_block["value"]["cards"]:

            old_url = card["value"].get("url")
            if old_url:
                card["value"]["link"] = [
                    {
                        "link_to": "external_url",
                        "external_url": old_url,
                        "new_window": True,
                    }
                ]

    return source_block


# Via foundation_cms.legacy_apps.wagtailpages.migrations.0148_update_imagegridblock_with_linkblock
def migrate_0148_image_grid_block(source_block):
    # Regex pattern for detecting URLs (including those without protocol)
    url_pattern = re.compile(r"^(http://|https://|www\.|[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+)")
    # Regex pattern for detecting emails
    email_pattern = re.compile(r"^mailto:")

    if "grid_items" in source_block["value"]:
        for item in source_block["value"]["grid_items"]:
            item_value = item.get("value", item)
            old_url = item_value.get("url")
            if old_url:
                if url_pattern.match(old_url):
                    item_value["link"] = [
                        {
                            "link_to": "external_url",
                            "external_url": old_url,
                            "new_window": True,
                        }
                    ]
                elif email_pattern.match(old_url):
                    email_address = old_url.replace("mailto:", "")
                    item_value["link"] = [
                        {
                            "link_to": "email",
                            "email": email_address,
                            "new_window": False,
                        }
                    ]
                elif old_url.startswith("/"):
                    item_value["link"] = [
                        {
                            "link_to": "relative_url",
                            "relative_url": old_url,
                            "new_window": False,
                        }
                    ]
                item = item_value

    return source_block


# Via foundation_cms.legacy_apps.wagtailpages.migrations.0149_update_listingblock_with_linkblock
def migrate_0149_listing_card_links(source_block):
    if "cards" in source_block["value"]:
        for card in source_block["value"]["cards"]:
            card_value = card.get("value", card)
            new_link = []

            link_page = card_value.get("link_page")
            if link_page:
                new_link.append(
                    {
                        "link_to": "page",
                        "page": link_page,
                        "new_window": False,
                    }
                )

            link_url = card_value.get("link_url")
            if link_url:
                new_link.append(
                    {
                        "link_to": "external_url",
                        "external_url": link_url,
                        "new_window": True,
                    }
                )

            card_value["link"] = new_link
            card = card_value

    return source_block


# Via foundation_cms.legacy_apps.wagtailpages.migrations.0150_update_textonlyteaserblock_with_linkblock
def migrate_0150_text_only_teaser_block(source_block):
    if "cards" in source_block["value"]:
        for card in source_block["value"]["cards"]:
            card_value = card.get("value", card)

            # Prepare the new link field
            new_link = []

            # Migrate link_page to the new link field
            link_page = card_value.get("link_page")
            if link_page:
                new_link.append({"link_to": "page", "page": link_page, "new_window": False})

            # Migrate link_url to the new link field
            link_url = card_value.get("link_url")
            if link_url:
                new_link.append(
                    {
                        "link_to": "external_url",
                        "external_url": link_url,
                        "new_window": True,
                    }
                )

            # Update the card value with the new link
            card_value["link"] = new_link
            card = card_value

    return source_block


class Migration(migrations.Migration):

    replaces = [
        ("wagtailpages", "0145_update_videoblock_with_linkblock"),
        ("wagtailpages", "0146_update_imageteaserblock_with_linkblock"),
        ("wagtailpages", "0147_update_grouplistingblock_with_linkblock"),
        ("wagtailpages", "0148_update_imagegridblock_with_linkblock"),
        ("wagtailpages", "0149_update_listingblock_with_linkblock"),
        ("wagtailpages", "0150_update_textonlyteaserblock_with_linkblock"),
    ]

    dependencies = [
        ("wagtailpages", "0144_alter_appinstallpage_hero_heading_and_more"),
    ]

    operations = [
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="articlepage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="video", operation=migrate_0145_video_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="blogpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="video", operation=migrate_0145_video_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="buyersguidearticlepage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="video", operation=migrate_0145_video_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="buyersguidecampaignpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="video", operation=migrate_0145_video_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="modularpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="video", operation=migrate_0145_video_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="primarypage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="video", operation=migrate_0145_video_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="modularpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="image_teaser_block", operation=migrate_0146_image_teaser_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="primarypage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="image_teaser_block", operation=migrate_0146_image_teaser_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="modularpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="group_listing_block", operation=migrate_0147_group_listing_block_cards
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="primarypage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="group_listing_block", operation=migrate_0147_group_listing_block_cards
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="articlepage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="image_grid", operation=migrate_0148_image_grid_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="blogpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="image_grid", operation=migrate_0148_image_grid_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="buyersguidearticlepage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="image_grid", operation=migrate_0148_image_grid_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="buyersguidecampaignpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="image_grid", operation=migrate_0148_image_grid_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="modularpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="image_grid", operation=migrate_0148_image_grid_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="primarypage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="image_grid", operation=migrate_0148_image_grid_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        migrations.AlterField(
            model_name="articlepage",
            name="body",
            field=wagtail.fields.StreamField([]),
        ),
        migrations.AlterField(
            model_name="blogpage",
            name="body",
            field=wagtail.fields.StreamField([]),
        ),
        migrations.AlterField(
            model_name="buyersguidearticlepage",
            name="body",
            field=wagtail.fields.StreamField([], null=True),
        ),
        migrations.AlterField(
            model_name="buyersguidecampaignpage",
            name="body",
            field=wagtail.fields.StreamField([]),
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="modularpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="listing", operation=migrate_0149_listing_card_links
                    ),
                    "",
                ),
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="listing", operation=migrate_0149_listing_card_links
                    ),
                    "block_with_aside.content",
                ),
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="primarypage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="listing", operation=migrate_0149_listing_card_links
                    ),
                    "",
                ),
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="listing", operation=migrate_0149_listing_card_links
                    ),
                    "block_with_aside.content",
                ),
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="modularpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="text_only_teaser", operation=migrate_0150_text_only_teaser_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="primarypage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="text_only_teaser", operation=migrate_0150_text_only_teaser_block
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        migrations.AlterField(
            model_name="modularpage",
            name="body",
            field=wagtail.fields.StreamField([]),
        ),
        migrations.AlterField(
            model_name="primarypage",
            name="body",
            field=wagtail.fields.StreamField([]),
        ),
    ]
