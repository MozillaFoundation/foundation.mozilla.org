# Generated by Django 4.2.25 on 2025-11-14 21:08

import re

import wagtail.blocks.migrations.migrate_operation
import wagtail.fields
from django.db import migrations

import foundation_cms.legacy_apps.utility.migration.operations

# Functions from the following migrations need manual copying.
# Move them and any dependencies into this file, then update the
# RunPython operations to refer to the local versions:
# foundation_cms.legacy_apps.wagtailpages.migrations.0154_update_cardgridblock_with_linkblock


# Via foundation_cms.legacy_apps.wagtailpages.migrations.0154_update_cardgridblock_with_linkblock
def migrate_0154_card_grid_block_cards(source_block):

    url_pattern = re.compile(r"^(http://|https://|www\.|[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+)")

    if "cards" in source_block["value"]:
        for card in source_block["value"]["cards"]:

            card_value = card.get("value", card)
            new_link = []

            link_url = card_value.get("link_url")
            link_label = card_value.get("link_label")

            if link_url and link_label:
                if url_pattern.match(link_url):
                    new_link.append(
                        {
                            "link_to": "external_url",
                            "external_url": link_url,
                            "new_window": True,
                            "label": link_label,
                        }
                    )
                else:
                    new_link.append(
                        {
                            "link_to": "relative_url",
                            "relative_url": link_url,
                            "new_window": False,
                            "label": link_label,
                        }
                    )

            # Update the card value with the new link
            card_value["link"] = new_link
            card = card_value

    return source_block


class Migration(migrations.Migration):

    replaces = [
        ("wagtailpages", "0153_update_baselinkblock_relative_link_validation"),
        ("wagtailpages", "0154_update_cardgridblock_with_linkblock"),
    ]

    dependencies = [
        ("wagtailpages", "0152_format_linkblock_empty_values"),
    ]

    operations = [
        migrations.AlterField(
            model_name="appinstallpage",
            name="download_buttons",
            field=wagtail.fields.StreamField([], blank=True),
        ),
        migrations.AlterField(
            model_name="blogindexpage",
            name="callout_box",
            field=wagtail.fields.StreamField(
                [], blank=True, help_text="Callout box that appears after the featured posts section"
            ),
        ),
        migrations.AlterField(
            model_name="dearinternetpage",
            name="cta_button",
            field=wagtail.fields.StreamField([], blank=True),
        ),
        migrations.AlterField(
            model_name="rcclandingpage",
            name="aside_cta",
            field=wagtail.fields.StreamField([], blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="researchlandingpage",
            name="aside_cta",
            field=wagtail.fields.StreamField([], blank=True, null=True),
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="articlepage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="card_grid", operation=migrate_0154_card_grid_block_cards
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="blogpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="card_grid", operation=migrate_0154_card_grid_block_cards
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="buyersguidearticlepage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="card_grid", operation=migrate_0154_card_grid_block_cards
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="buyersguidecampaignpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="card_grid", operation=migrate_0154_card_grid_block_cards
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="modularpage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="card_grid", operation=migrate_0154_card_grid_block_cards
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        wagtail.blocks.migrations.migrate_operation.MigrateStreamData(
            app_name="wagtailpages",
            model_name="primarypage",
            field_name="body",
            operations_and_block_paths=[
                (
                    foundation_cms.legacy_apps.utility.migration.operations.AlterStreamChildBlockDataOperation(
                        block="card_grid", operation=migrate_0154_card_grid_block_cards
                    ),
                    "",
                )
            ],
            revisions_from=None,
            chunk_size=1024,
        ),
        migrations.AlterField(
            model_name="articlepage",
            name="body",
            field=wagtail.fields.StreamField([]),
        ),
        migrations.AlterField(
            model_name="buyersguidearticlepage",
            name="body",
            field=wagtail.fields.StreamField([], null=True),
        ),
        migrations.AlterField(
            model_name="buyersguidecampaignpage",
            name="body",
            field=wagtail.fields.StreamField([]),
        ),
        migrations.AlterField(
            model_name="modularpage",
            name="body",
            field=wagtail.fields.StreamField([]),
        ),
        migrations.AlterField(
            model_name="primarypage",
            name="body",
            field=wagtail.fields.StreamField([]),
        ),
    ]
