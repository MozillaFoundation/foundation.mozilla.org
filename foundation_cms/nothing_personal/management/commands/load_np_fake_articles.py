import random
from datetime import timedelta

from django.core.management import call_command
from django.core.management.base import BaseCommand, CommandError
from django.db import transaction
from django.utils import timezone
from django.utils.text import slugify
from wagtail.models import Locale, Page, Site

from foundation_cms.base.models.abstract_base_page import Author, Topic
from foundation_cms.base.utils.helpers import to_streamfield_value
from foundation_cms.nothing_personal.models import NothingPersonalArticlePage, NothingPersonalHomePage


DEFAULT_KEYWORD = "NP_PAGINATION_TEST"
DEFAULT_COUNT = 70


class Command(BaseCommand):
    help = (
        "Create fake Nothing Personal articles for testing search pagination. "
        "Generates published NothingPersonalArticlePage pages with authors and topics."
    )

    def add_arguments(self, parser):
        parser.add_argument(
            "--count",
            type=int,
            default=DEFAULT_COUNT,
            help=f"Articles to create (default: {DEFAULT_COUNT}).",
        )
        parser.add_argument(
            "--keyword",
            type=str,
            default=DEFAULT_KEYWORD,
            help=f"Keyword injected into titles/body for easy searching (default: {DEFAULT_KEYWORD}).",
        )
        parser.add_argument("--seed", type=int, default=None, help="Seed for repeatable content generation.")
        parser.add_argument(
            "--delete",
            action="store_true",
            help=(
                "Delete existing NothingPersonalArticlePage children of the Nothing Personal home page "
                "before creating."
            ),
        )
        parser.add_argument(
            "--update-index",
            action="store_true",
            help="Run Wagtail update_index after creation (useful if using Elasticsearch).",
        )

    def _ensure_np_homepage(self) -> NothingPersonalHomePage:
        default_locale = Locale.get_default()

        existing = NothingPersonalHomePage.objects.filter(locale=default_locale).first()
        if existing:
            if not existing.live:
                existing.save_revision().publish()
            return existing

        site = Site.objects.filter(is_default_site=True).first() or Site.objects.first()
        if not site:
            raise CommandError("No Wagtail Site found; run load_redesign_data (or create a Site) first.")

        parent = site.root_page.specific

        if not isinstance(parent, Page):
            parent = site.root_page

        # NothingPersonalHomePage.parent_page_types = ["core.HomePage"], and the redesign loader
        # sets the site root to a HomePage, so making NP home a child should be valid.
        np_home = NothingPersonalHomePage(
            title="Nothing Personal",
            slug="nothing-personal",
            theme="nothing_personal",
            locale=default_locale,
        )
        parent.add_child(instance=np_home)
        np_home.save_revision().publish()
        return np_home

    def _get_or_create_authors(self, count: int = 5) -> list[Author]:
        authors: list[Author] = []
        for i in range(1, count + 1):
            author, _ = Author.objects.get_or_create(
                name=f"NP Test Author {i}",
                defaults={"bio": "Autogenerated author for pagination/search testing."},
            )
            authors.append(author)
        return authors

    def _get_or_create_topics(self, count: int = 6) -> list[Topic]:
        topics: list[Topic] = []
        for i in range(1, count + 1):
            topic, _ = Topic.objects.get_or_create(
                name=f"NP Test Topic {i}",
                defaults={"description": "Autogenerated topic for pagination/search testing."},
            )
            topics.append(topic)
        return topics

    def _unique_slug(self, base: str, used: set[str]) -> str:
        base_slug = slugify(base)[:240] or "np-article"
        slug = base_slug
        i = 2
        while slug in used:
            slug = f"{base_slug}-{i}"
            i += 1
        used.add(slug)
        return slug

    @transaction.atomic
    def handle(self, *args, **options):
        count: int = options["count"]
        keyword: str = (options["keyword"] or DEFAULT_KEYWORD).strip()
        seed = options["seed"]

        if count <= 0:
            raise CommandError("--count must be > 0")
        if not keyword:
            raise CommandError("--keyword must be a non-empty string")

        if seed is None:
            seed = random.randint(0, 5_000_000)

        self.stdout.write(f"Seeding random with: {seed}")
        random.seed(seed)

        np_home = self._ensure_np_homepage()

        if options["delete"]:
            self.stdout.write("Deleting existing Nothing Personal article pages...")
            NothingPersonalArticlePage.objects.descendant_of(np_home).delete()

        authors = self._get_or_create_authors()
        topics = self._get_or_create_topics()

        used_slugs = set(NothingPersonalArticlePage.objects.values_list("slug", flat=True))

        self.stdout.write(f"Creating {count} Nothing Personal articles with keyword '{keyword}'...")

        model_instance = NothingPersonalArticlePage()
        created = 0

        for i in range(1, count + 1):
            title = f"{keyword} Nothing Personal Article {i}"
            slug = self._unique_slug(title, used_slugs)

            # Spread publish dates a bit for more natural ordering.
            published_at = timezone.now() - timedelta(days=(count - i))

            lede_text = f"{keyword} lede text for pagination/search testing. Article #{i}."
            body_html = f"<p>{keyword} body content. This is autogenerated article {i}.</p>"

            page = NothingPersonalArticlePage(
                title=title,
                slug=slug,
                theme="nothing_personal",
                locale=np_home.locale,
                lede_text=lede_text,
                search_description=lede_text[:250],
                displayed_hero_content=NothingPersonalArticlePage.HERO_CONTENT_VIDEO,
                hero_video_url="https://example.com/video.mp4",
                hero_image_alt_text=f"{keyword} hero alt text {i}",
            )

            # StreamField values should be assigned as StreamValue; use helper.
            page.body = to_streamfield_value(
                [{"type": "rich_text", "value": body_html}],
                stream_block=model_instance.body.stream_block,
            )

            # Set author before adding/publishing.
            page.author = random.choice(authors)

            np_home.add_child(instance=page)

            # Topics (ClusterTaggableManager) needs a PK, so add after add_child.
            selected_topics = random.sample(topics, k=random.randint(1, min(3, len(topics))))
            page.topics.add(*selected_topics)

            # Ensure publish timestamps are roughly deterministic.
            if hasattr(page, "first_published_at"):
                page.first_published_at = published_at
            if hasattr(page, "last_published_at"):
                page.last_published_at = published_at

            page.save_revision().publish()
            created += 1

        self.stdout.write(self.style.SUCCESS(f"Done! Created and published {created} Nothing Personal articles."))
        self.stdout.write(self.style.SUCCESS(f"Search for: {keyword}"))
        self.stdout.write("Expected pages (10/page): %s" % ((created + 9) // 10))

        if options["update_index"]:
            self.stdout.write("Running update_index...")
            call_command("update_index")
            self.stdout.write(self.style.SUCCESS("update_index complete."))
